/** Script to rename bookmarks based on text in selected areas of the page
  * @author Mathew Bittleston
  * @license MIT
  *
  * History:
  * v1.5   2025-08-21 option to also set page labels
  * v1.4.1 2025-08-06 clarify license
  * v1.4   2025-07-31 correctly place selected region when page offset, rotation or crop changes; slight change to dialog layout & preview; move GetPageRectangle to xutil
  * v1.3   2025-04-28 fix bug when pdf has no bookmarks, fix bug with title case, scroll page to show selected region, moved tool to end of bp.rbar.create, remove from add-on toolbar
  * v1.2   2025-04-06 add Initial Capitals to distinguish from Title Case (conjunctions not capitalized); increase find history to 20 in drop down; indicate if "all bookmarks" are picked
  * v1.1   2025-04-04 change menu button name, move addBookmark v3 to xutils (doesn't require translation), update selected text preview, add buttons to move current page, minify (jsTool)
  * v1.0   2025-02-01 option to add bookmarks or apply to selected bookmarks
  * v0.5   2024-11-11 make translateable, add to Bookmarks menu or ribbon, clean up lint errors
  * v0.4   2024-06-20 fix bug with dialog loading when sRgs updates
  * v0.3.3 2024-06-11 remove label, rename to put at end of toolbar, updated tooltext
  * v0.3.2 2024-05-14 update alert if no bookmarks, fix undefined variable bug
  * v0.3.1 2024-05-14 added alert if no bookmarks to rename, update selStage before deleting a stage
  * v0.3   2024-05-14 deal with cropBox not at [0,0], page view rotation fix, cache page words
  * v0.2   2024-05-11 add option to strip whitespace only (not punctuation), add progress dialog, macros on prefix/suffix, anchor radios, sort order on words, option for fully inside rect
  * v0.1 first working version
  *
  * @todo  profile dropdown
  *        option to add links
  *        warning for pages that no text is found
  *        determine if 'words' are word fragments (ie the pdf broke them up, but actually they are right next to each other with no space) - needs to take into account the sort order, page rotation, etc
  *
  * @requires depends on xutil for getNewAnn, PXEmacro, addBookmark. If using translations, need 1ang.js
**/
if('undefined'===typeof __)__=(t)=>t;var myIcon={count:0,width:50,height:50,read:function(nBytes=this.data.length/2){return this.data.slice(this.count,this.count+=2*nBytes);},data:(a=>{let[b,c]=a.split(":");c=c?.match(/.{8}/g);let d=(a,b)=>a.replace(/./g,a=>parseInt(a,10+b)-b);return b.replace(/([g-p]+)([0-9a-f]+|[q-z]+)/gi,(a,b,e)=>(/[q-z]/.test(e)?c[d(e,26)]:e).repeat(d(b,16)));})("hljshrrhrsihuhFF7F7F7FhFF909090h40F0F0F0ijshrrijuhrxhyh80B5B5B5ijshrshuhryigrhFFF2F2F2hrzhyhFF6B6B6Bh40EBEBEBiisiuihrhFF9C9C9Cjyh80A6A6A6iisiuhrhlvkrhFFD7D7D7kyhFF656565h80E2E2E2ihsiuhrhlvkrhFF969696lyh80969696ihsiuhrivhhxivkrhrxmyh80D7D7D7igsiuhrivhhxivkrhFFBEBEBEmyh80858585igsiuhrivhhxivkrhFFFEFEFEhFFA3A3A3hFF606060lyh80C8C8C8hpsiuhrivhhxivmrhFFD8D8D8hFF797979kyhFF787878h40F1F1F1hosiuhrivhhxivnrhsqhFFB0B0B0hFF636363jyh80B8B8B8hosiuhrivhhxivprhFFE5E5E5hFF878787iyhrzh80ECECEChnsiuhrivjxorvirtkrhsrhssoqh80F4F4F4hnsiuhrivjxorvirtjrhsqhhqhnsiuhrivhhxivirhsrhqhFFF1F2F4hsthrwhkthrwh8087C3F4hFFEDF0F4osiuhrivhhxivirhsshqhsthoth8066B5F4osiuhrivhhxiviriqhrwhthFF6CB7F4hFFE3ECF4hmqosiuhrivhhxiviriqithFFE5EDF4hnqosiuhrivjxorvirtirqiqitiqhFFC4DFF4hsuhkwh806BB0E8hsvhFF4090D0h80B0CFE7ksiuhrlvhgrtirqiqitiqhsuhlwhsvizhFF4090D1ksiuhrhlviriqitiqhmwkzksiuhoriqitiqhmwkzksiuhoriqitiqhmwkzksiuhoriqitiqhmwkzksiumrhirqiqitiqhlwhswkzksiumrhirqiqitiqhjwhsxhsyhtkzksiuhoriqitiqhiwhszhtqitkzksiuhoriqitiqhhwhtrhtsjtkzksiuhoriqitiqhgwhtthtuktosiuhoriqitiqpwhtvhtwltosiumrhirqiqitiqowhtxntosiumrhirqiqitiqnwhswotosiuhoriqitiqlwhsxhsyptosiuhoriqitiqkwhszhtqhgtosiuhoriqitiqjwhtrhtshhtosiuhoriqitiqiwhtthtuhitosiuhoriqitiqhwhtvhtwhjtosiuhoriqitiqhtxhltosiuhoriqitiqhmtoshrshuhryhnriqhFF48A8F4htiqhmtoshrrhpuhFFDFDFDFhqhFF74BBF4htiqnth809ECEF4h809FCEF4ntpshrrhrshnuhFFB8B8B8hqhFFD8E7F4hFF59AFF4iqlthruh80A6D1F4ish80A7D2F4hrultjkskthtyh80AED5F4ksh80B0D5F4htyktjksjthFF44A6F4h80B5D8F4msh80B7D9F4hFF45A6F4jtjkshruhthFF46A6F4h80BCDBF4osh80BEDCF4hFF46A7F4hthrujksh8079BDF4hFF57AEF4h80C3DEF4hgsh80C5DFF4hFF56AEF4h807EBFF4lms:FFF4F4F4FFFFFFFF00000000FF42A5F5FF808080FF5FC75FFF71BBF7FF7CFF7CFF616161FF388CD0FF9E9E9E80B3B3B3FF868686FF38BB38FF42A5F4FF4AF04AFF4CA9F4FF8E8E8EFFDDDDDDFF6D6D6DFFF9F9F9FFFBFBFBFFF6F6F6FF90C8F4FF76BDF6FF3D8ED0FF56AEF6FF6FBAF7FF51ACF5FF6EBAF7FF4DAAF5FF6AB8F7FF49A8F5FF66B6F6FF46A7F5FF62B4F6FF44A6F5FF5DB2F6FF43A5F4")};app.addMenuItem({cName:"bkmNameRegionMenu",cUser:__("From Page Areas…",'bkmNameReg'),cTooltext:__("Name Bookmarks by Page Areas\n────────────────────────\nAdd bookmarks or rename current bookmarks based on text in selected areas of pages.",'bkmNameReg'),oIcon:myIcon,cParent:"cmd.bp",nPos:"cmd.bp.generate",cRbParent:"bp.rbar.create",nRbPos:-1,cEnable:"event.rc = (event.target != null);",cExec:'bkmNameRegions(this)'});app.addToolButton({cName:"bkmNameRegionButton",cUser:"From Page Areas…",cLabel: 'From Page Areas…',cTooltext:"Name Bookmarks by Page Areas\n────────────────────────\nAdd bookmarks or rename current bookmarks based on text in selected areas of pages.",oIcon:myIcon,cEnable:"event.rc = (event.target != null);",cExec:'bkmNameRegions(this)'});
var bkmNameRegions=(function(){const BK_PREFS=(name=>{let get=app.trustedFunction(()=>{app.beginPriv();if(global[name])
return JSON.parse(global[name]);});let set=app.trustedFunction(value=>{app.beginPriv();global[name]=JSON.stringify(value);global.setPersistent(name,true);});return{get,set};})("bkmNameRegionsPrefs");function selectBookmarks(doc){const bkmDia={bkm:[],sel:[-1],initialize(dialog){dialog.load({sub1:this.loadHier(this.bkm,this.sel,dialog.itemIdKey)});},commit(dialog){this.sel=this.getIndex(dialog.store().sub1,dialog.itemIdKey);this.results=this.bkmFlatList(this.sel);},getIndex(elements,parentId){const ixs=[];if(parentId){if(elements[parentId]>0)ixs.push(elements[parentId]-1);}
for(let v of Object.values(elements)){let ix;if('object'===typeof v){ix=this.getIndex(v,parentId);}else if(v>0){ix=v-1;}
if(undefined!==ix){if(Array.isArray(ix)){ixs.push(...ix);}else{ixs.push(ix);}}}
if(ixs.length<2){return ixs[0];}
return ixs;},loadHier(vals,sel,parentId){if(undefined===sel)sel=0;if(!Array.isArray(sel))sel=[sel];let ix=0;const isSelected=i=>i*(sel.includes(i-1)?1:-1);return getLB(vals);function getLB(vals){const sub={};if(ix++&&parentId){sub[parentId]=isSelected(ix-1);}
for(let val of vals){let uk=val.name;if(sub[uk]){let i=1;while(sub[uk+'_'+i])i++;uk+='_'+i;}
if(val.children){sub[uk]=getLB(val.children);}else{sub[uk]=isSelected(ix++);}}
return sub;}},bkmFlatList(sel){if(!Array.isArray(sel))sel=[sel];let ix=0;return getBL(this.bkm);function getBL(vals){const sub=[];for(let val of vals){if(sel.includes(ix++)){sub.push(val);}
if(val.children){sub.push(...getBL(val.children));}}
return sub;}},description:{name:'Select Bookmarks',elements:[{type:'static_text',name:__("Select all bookmarks to rename.",'bkmNameReg'),bold:true},{type:'hier_list_box',item_id:"sub1",char_width:40,height:600,sort:false,multi_select:true},{type:'static_text',name:__("Hold down SHIFT to select multiple contiguous, CTRL to select multiple discontiguous.",'bkmNameReg'),char_width:40},{type:"ok_cancel"}]}};bkmDia.bkm=doc.bookmarkRoot.children;if(!bkmDia.bkm)return;bkmDia.sel=(this.selBkmIx??-1);if('ok'===app.execDialog(bkmDia)){this.selBkmIx=bkmDia.sel;return bkmDia.results;}}
return function(doc){"use strict";const MAX_FIND_HISTORY=25;const TITLE_LOWER_CASE=__("a,an,the,for,and,nor,but,or,yet,so,as,at,by,for,in,of,on,per,pro,sub,thru,to,up,re,ca.,vs.,v.,w/,w/o",'bkmNameReg').split(/\s*,\s*/);const allBookmarks=getAllBookmarks(doc.bookmarkRoot);const globalData=BK_PREFS.get()||{profile:0,data:[[]]};let curProf=globalData.profile;const searchData=globalData.data;const findHist=globalData.findHist||[];const replHist=globalData.replHist||[];let setLabel=globalData.setLabel||false;let dDirtyState=doc.dirty;const bkmRegionDialog={profiles:[],curProf:0,selStage:0,selPages:{type:'bookmarks',bookmarks:[],pages:[]},toSave:["name","case","prex","sufx","ftxt","rtxt","usRE","casS","rmPW",'srtX','wdsI'],pop:{'srt0':[' ','\u2193 Down','\u2191 Up','\u2192 LtR','RtL \u2190'],'srt1':[' ','\u2193 Down','\u2191 Up','\u2192 LtR','RtL \u2190'],"case":[__("No change",'bkmNameReg'),__("UPPER CASE",'bkmNameReg'),__("lower case",'bkmNameReg'),__("Initial Caps",'bkmNameReg'),__("Title Case",'bkmNameReg')],},initialize(dialog){this.mx=new xutil.PXEmacro();this.pop['mcr0']=this.pop['mcr1']=this.pop['mcr2']=this.mx.initializePopup(['%[BookmarkName]']);this.updateStages(dialog);this.applyProfile(dialog);dialog.load({'apPG':true});if(!allBookmarks.length){dialog.enable({'apSB':false,'piSB':false});}else if("object"===typeof app.pxceVersion&&app.pxceVersion[3]<393){dialog.visible({'piSB':false});this.selPages.bookmarks=allBookmarks;dialog.load({'txSB':__("All bookmarks",'bkmNameReg')});}
this.chgBkPk(dialog);},commit(dialog){const dLoad=dialog.store();const selStage=this.getIndex(dLoad["sRgs"]);this.saveStep(selStage,dLoad);this.selStage=selStage;if(dLoad.apPG){this.selPages.type='pages';const pRange=dLoad.pPKa?'1-':dLoad.piPG;this.selPages.pages=getPagesFromText(pRange,doc.numPages);}
setLabel=dLoad['setL'];},saveStep(selStage,dLoad){const search=this.profiles[this.curProf][selStage];let didChange=false;let sVals=Object.assign({},dLoad);for(let d in this.pop){sVals[d]=this.getIndex(dLoad[d]);}
sVals["rmPW"]=this.wsRadioOpt(dLoad);sVals['srtX']=['srt0','srt1'].map(i=>sVals[i]);if(search){this.toSave.forEach(f=>{if(search[f]!==sVals[f]){didChange=true;search[f]=sVals[f];}});}
let align=this.getAlign(sVals);if(align.toString()!==search["align"].toString()){const rec=new xutil.GetPageRectangle(doc,doc.pageNum);if(search.rect){let rect=rec.fromRel(search.rect,search["align"]);search.rect=rec.toRel(rect,align);}
search["align"]=align;}
return didChange;},applyProfile(dialog){const search=this.profiles[this.curProf];const sStg=search[this.selStage];const frHist={'ftxt':findHist,'rtxt':replHist};let dLoad={'Stxt':__("Select Region:",'bkmNameReg'),'wdsI':true,'srtX':[0,0],'setL':setLabel};if(sStg){let align=sStg.align??[0,2];dLoad[this.getAxBox(align)]=true;this.toSave.forEach(f=>dLoad[f]=sStg[f]??'');if(sStg.rect){dLoad['Stxt']=this.getPageTx(sStg);}
if(this.ann){if(sStg.rect){this.ann.hidden=false;this.ann.page=doc.pageNum;const rec=new xutil.GetPageRectangle(doc,doc.pageNum);this.ann.rect=rec.fromRel(sStg.rect,sStg.align);zoomToAnn(this.ann);}else{this.ann.hidden=true;}}
for(let fr in frHist){let i=frHist[fr].findIndex(e=>e===dLoad[fr]);if(0>i){this.addHistory('ftxt'===fr?findHist:replHist,dLoad[fr]);i=0;}
dLoad[fr]=i;}
dLoad['srt0']=(sStg.srtX??dLoad.srtX)[0];dLoad['srt1']=(sStg.srtX??dLoad.srtX)[1];}
for(let d in frHist){dLoad[d]=this.getListboxArray(frHist[d],dLoad[d]);}
for(let d in this.pop){dLoad[d]=this.getListboxArray(this.pop[d],dLoad[d]);}
for(let i=2;i--;){dLoad[`rm0${i}`]=(dLoad["rmPW"]>=i);}
dialog.load(dLoad);let enable={"EdRg":1,"DeRg":1,"MvUp":1,"MvDn":1,'rm02':dLoad['rm01']??false};if(!search.length){["EdRg","DeRg","MvUp","MvDn"].forEach(i=>enable[i]=false);}else if(1===search.length){["MvUp","MvDn"].forEach(i=>enable[i]=false);}
dialog.enable(enable);},updateStages(dialog){const search=this.profiles[this.curProf];const dLoad={};if(search[this.selStage]){dLoad['sRgs']=this.getListboxArray(this.getDialogList(search),this.selStage||0);}else{dLoad['sRgs']={};}
dialog.load(dLoad);},sRgs(dialog){const dLoad=dialog.store();const nStage=this.getIndex(dLoad["sRgs"]);if("undefined"!==typeof nStage&&nStage!==this.selStage){const doUpdate=this.saveStep(this.selStage,dLoad);this.selStage=this.getIndex(dLoad["sRgs"]);if(doUpdate)this.updateStages(dialog);this.applyProfile(dialog);}},AdRg:function(dialog){const search=this.profiles[this.curProf];if(search.length){this.saveStep(this.selStage,dialog.store());}
let rDefaults={"name":__('Step %1','bkmNameReg',(search.length+1)),"align":[0,2],"rmPW":1};search.push(rDefaults);this.selStage=search.length-1;this.updateStages(dialog);this.applyProfile(dialog);},EdRg:function(dialog){this.sRgs(dialog);},DeRg:function(dialog){const search=this.profiles[this.curProf];this.sRgs(dialog);search.splice(this.selStage,1);if(this.selStage&&this.selStage>search.length-1){this.selStage--;}
this.updateStages(dialog);this.applyProfile(dialog);},MvUp(dialog){this.moveStage(dialog,false);},MvDn(dialog){this.moveStage(dialog,true);},moveStage(dialog,down=true){const dResult=dialog.store();const edField=this.getIndex(dResult["sRgs"]);const search=this.profiles[this.curProf];const doMove=down?(edField<search.length-1):(edField>0);if(doMove){this.saveStep(this.selStage,dResult);search.splice(edField+(down?1:-1),0,search.splice(edField,1)[0]);this.selStage=edField+(down?1:-1);this.updateStages(dialog);}
return doMove;},Sbtn(dialog){if(!this.profiles[this.curProf].length){this.AdRg(dialog);}
this.commit(dialog);dialog.end('pickarea');},addHistory(fOb,fVal){if(fOb.includes(fVal)){fOb.splice(fOb.indexOf(fVal),1);}
fOb.unshift(fVal);if(fOb.length>MAX_FIND_HISTORY){fOb.splice(MAX_FIND_HISTORY-1);}},mcr0(dialog){this.mx.handlePopup(dialog,'mcr0','prex');},mcr1(dialog){this.mx.handlePopup(dialog,'mcr1','sufx');},mcr2(dialog){this.mx.handlePopup(dialog,'mcr2','rtxt');},rm01(dialog){const dStore=dialog.store();if(null==dStore['rm01'])return;const dLoad={'rm02':dStore['rm01']};dialog.enable(dLoad);const search=this.profiles[this.curProf][this.selStage];if(search)search['rmPW']=this.wsRadioOpt(dStore);this.updateTxPrw(dialog);},rm02(dialog){const dStore=dialog.store();if(null==dStore['rm01'])return;const search=this.profiles[this.curProf][this.selStage];if(search)search['rmPW']=this.wsRadioOpt(dStore);this.updateTxPrw(dialog);},wsRadioOpt(dLoad){return dLoad['rm01']?(dLoad['rm02']?2:1):0;},piSB(dialog){const selBks=selectBookmarks(doc);if(selBks?.length){this.selPages.bookmarks=selBks;const dLoad={'apSB':true};if(this.selPages.bookmarks.length===allBookmarks.length){dLoad.txSB=__("All bookmarks",'bkmNameReg');}else{dLoad.txSB=__("%1 Selected",'bkmNameReg',this.selPages.bookmarks.length);}
dialog.load(dLoad);}},piPG(dialog){const data=dialog.store();if(data.piPG&&data.piPG.trim()){const dLoad={'apPG':true,'pPKc':true};dialog.load(dLoad);}},apSB(dialog){this.chgBkPk(dialog);if(dialog.store()['apSB']&&!this.selPages.bookmarks?.length){this.selPages.bookmarks=allBookmarks;dialog.load({'txSB':__("All bookmarks",'bkmNameReg')});}},apPG(dialog){this.chgBkPk(dialog);},chgBkPk(dialog){const data=dialog.store();this.selPages.type=data.apPG?'pages':'bookmarks';const dEnable={pPKa:data.apPG,pPKc:data.apPG};dialog.enable(dEnable);},srt0(dialog){this.updateSortOrder(dialog,0);},srt1(dialog){this.updateSortOrder(dialog,1);},updateSortOrder(dialog,id){const search=this.profiles[this.curProf][this.selStage];if(search){let i=this.getIndex(dialog.store()['srt'+id]);if(null==i)return;const oldSrtX=search['srtX']??[0,0];oldSrtX[id]=i;search['srtX']=oldSrtX;this.updateTxPrw(dialog);}},wdsI(dialog){let i=dialog.store()['wdsI'];if(null==i)return;const search=this.profiles[this.curProf][this.selStage];if(search)search['wdsI']=i;this.updateTxPrw(dialog);},updateTxPrw(dialog){const search=this.profiles[this.curProf];const sStg=search[this.selStage];if(sStg?.rect){dialog.load({'Stxt':this.getPageTx(sStg)});}},pgLf(dialog){const dVals=dialog.store();const doUpdate=this.saveStep(this.selStage,dVals);this.getNextSelectedPage(dVals,false);if(doUpdate)this.updateStages(dialog);this.applyProfile(dialog);},pgRt(dialog){const dVals=dialog.store();const doUpdate=this.saveStep(this.selStage,dVals);this.getNextSelectedPage(dVals,true);if(doUpdate)this.updateStages(dialog);this.applyProfile(dialog);},getNextSelectedPage(dVals,increase){let currentPg=this.ann?this.ann.page:doc.pageNum;let pRange;const incrDecr=(rIx,rLen)=>{if(rIx<0){rIx=0;}else{rIx=increase?(rIx+1)%rLen:(rIx?rIx-1:rLen-1);}
return rIx;};switch(dVals.apPG){case true:if(dVals.pPKa){currentPg=incrDecr(currentPg,doc.numPages);}else{pRange=getPagesFromText(dVals.piPG,doc.numPages);currentPg=pRange[incrDecr(pRange.indexOf(currentPg),pRange.length)];}
doc.pageNum=currentPg;break;default:if(!this.selPages.bookmarks?.length){currentPg=increase?(currentPg+1)%doc.numPages:(currentPg?currentPg-1:doc.numPages-1);break;}
let bkIter=0;let foundPage=false;const bL=this.selPages.bookmarks.length;do{this.selPages.bookmarks[bkIter++].execute();foundPage=currentPg===doc.pageNum;}while(bkIter<bL&&!foundPage);if(foundPage){if(!increase){bkIter=(bkIter===1)?bL-1:(bkIter-2);}
this.selPages.bookmarks[bkIter%bL].execute();currentPg=doc.pageNum;}else{this.selPages.bookmarks[0].execute();currentPg=doc.pageNum;}}},getIndex:function(elements){for(let i in elements){if(elements[i]>0){return elements[i]-1;}}},getListboxArray:function(vals,selItem=0){let sub={};for(let i=0;i<vals.length;i++){sub[vals[i]]=((selItem===i)?1:-1)*(i+1);}
return sub;},getAlign(results){const axes=["AxTL","AxTC","AxTR","AxML","AxMC","AxMR","AxBL","AxBC","AxBR"];let align;for(let a of axes){if(results[a]){align=getAxis(a);break;}}
function getAxis(axTx){const hv=[['R','C','L'],['T','M','B']];const axis=hv.map((aList,i)=>aList.reduce((acc,a,j)=>(axTx.indexOf(a)>=0)?j:acc,0));return axis;}
return align;},getAxBox(axis){let axTx='Ax';const hv=[['R','C','L'],['T','M','B']];for(let a=1;a>=0;a--){axTx+=hv[a][axis[a]];}
return axTx;},getPageTx(stageData){const pageRect=new xutil.GetPageRectangle(doc,doc.pageNum);if(!this.pageWords||this.pageWords.page!==doc.pageNum){this.pageWords=new PageRectWords(doc,doc.pageNum);}
const rect=pageRect.fromRel(stageData.rect,stageData.align);let words=this.pageWords.words(rect,stageData.srtX,stageData.rmPW,stageData.wdsI??false);words=words.join(' ').replace(/\s+/g,' ');if(!/\S/.test(words))words=__('Region selected (no text found in it.)','bkmNameReg');return words;},getDialogList(sData){const aBrv=[['R','C','L'],['T','M','B']];const tBrv=[" ","UC","lc","IC","TC"];const maxLen=12;const bk=[];for(let s of sData){let sd=Object.assign({'align':[],'rect':[],'name':'','prex':'','sufx':'','case':0,'ftxt':'','rtxt':''},s);let align=sd['align'].map((a,i)=>aBrv[i][a]).join('');let recData=this.getPageTx(sd).substring(0,maxLen);let bkTx=sd['name']+':';bkTx+=sd['prex']?(' '+sd['prex']).substring(0,maxLen):'';bkTx+=sd['rect']?.toString()?` [${align}: ${recData}]`:'';bkTx+=sd['sufx']?sd['sufx'].substring(0,maxLen):'';console.println(JSON.stringify(sd));bkTx+=(sd['case']||sd['ftxt'])?' | '+(tBrv[sd['case']||0]??''):'';bkTx+=sd['ftxt']?' F/R'+(sd['usRE']?'.rx':''):'';bk.push(bkTx);}
return bk;},description:{name:__("Name Bookmarks from Page Regions",'bkmNameReg'),first_tab:'AdRg',align_children:"align_left",elements:[{type:'view',align_children:'align_top',elements:[{type:"view",width:200,item_id:'Lcol',elements:[{type:'cluster',align_children:"align_left",name:__("Apply to",'bkmNameReg'),elements:[{type:"view",align_children:"align_row",elements:[{type:"radio",group_id:'aply',item_id:'apSB',name:__("Rename Bookmarks",'bkmNameReg'),},{type:"button",item_id:'piSB',name:'…',char_width:3},{type:"static_text",item_id:'txSB',name:__("%1 Selected",'bkmNameReg',0),alignment:"align_fill"}]},{type:"radio",group_id:'aply',item_id:'apPG',name:__("Add Bookmarks…",'bkmNameReg'),},{type:"view",align_children:"align_row",elements:[{type:'gap',width:30,},{type:"radio",group_id:'pgPK',item_id:'pPKa',name:__("All Pages",'bkmNameReg'),},{type:"radio",group_id:'pgPK',item_id:'pPKc',name:__("Custom:",'bkmNameReg'),},{type:"edit_text",item_id:'piPG',width:90}]}]},{type:'check_box',item_id:'setL',name:__("Also Set Page Label",'bkmNameReg')},{type:'cluster',align_children:"align_left",name:__("Selected Regions:",'bkmNameReg'),elements:[{type:"view",align_children:"align_row",item_id:'ctrls',elements:[{type:"button",name:__("Add…",'bkmNameReg'),width:50,alignment:"align_left",item_id:"AdRg"},{type:"button",name:"▲",width:20,alignment:"align_left",item_id:"MvUp"},{type:"button",name:"▼",width:20,alignment:"align_left",item_id:"MvDn"},{type:"gap",width:40},{type:"button",name:__("Remove",'bkmNameReg'),width:55,alignment:"align_left",item_id:"DeRg"}]},{type:"list_box",alignment:"align_fill",height:200,width:250,item_id:"sRgs"},]}]},{type:'view',align_children:"align_left",width:400,elements:[{type:"view",elements:[{type:'view',elements:[{type:"edit_text",width:200,bold:true,item_id:"name"},{type:'static_text',name:__("Region: [nothing selected]",'bkmNameReg'),alignment:'align_fill',char_height:3,item_id:"Stxt",}]},{type:'view',align_children:'align_top',elements:[{type:"view",align_children:"align_top",elements:[{type:"view",elements:[{type:"button",name:__("Select Region",'bkmNameReg'),width:140,height:30,bold:true,item_id:"Sbtn"},{type:'check_box',name:__('100% inside','bkmNameReg'),item_id:'wdsI'}]},{type:"cluster",name:__("Anchor",'bkmNameReg'),width:50,align_children:"align_left",elements:[{type:"view",align_children:"align_row",elements:[{type:"radio",groupid:"Axes",item_id:"AxTL",width:14,height:14},{type:"radio",groupid:"Axes",item_id:"AxTC",width:14,height:14},{type:"radio",groupid:"Axes",item_id:"AxTR",width:14,height:14},]},{type:"view",align_children:"align_row",elements:[{type:"radio",groupid:"Axes",item_id:"AxML",width:14,height:14},{type:"radio",groupid:"Axes",item_id:"AxMC",width:14,height:14},{type:"radio",groupid:"Axes",item_id:"AxMR",width:14,height:14},]},{type:"view",align_children:"align_row",elements:[{type:"radio",groupid:"Axes",item_id:"AxBL",width:14,height:14},{type:"radio",groupid:"Axes",item_id:"AxBC",width:14,height:14},{type:"radio",groupid:"Axes",item_id:"AxBR",width:14,height:14},]}]}]},{type:'cluster',align_children:'align_left',name:__('Word order','bkmNameReg'),elements:[{type:'popup',item_id:'srt0',width:50},{type:'popup',item_id:'srt1',width:50}]},{type:'cluster',align_children:'align_center',name:__("PV",'bkmNameReg'),elements:[{type:'button',name:'<',bold:true,item_id:'pgLf',width:20,height:20,},{type:'button',name:'>',bold:true,item_id:'pgRt',width:20,height:20,}]}]}]},{type:"cluster",name:__("Text",'bkmNameReg'),elements:[{type:'view',align_children:'align_row',elements:[{type:'static_text',name:__('White space','bkmNameReg'),width:80,alignment:'align_right'},{type:'check_box',item_id:'rm01',name:__('Strip white space','bkmNameReg')},{type:'check_box',item_id:'rm02',name:__('Strip punctuation','bkmNameReg')}]},{type:"view",align_children:"align_row",elements:[{type:"static_text",name:__("Before:",'bkmNameReg'),width:50,alignment:"align_right",},{type:"edit_text",width:260,alignment:"align_fill",item_id:"prex"},{type:"popup",width:17,item_id:"mcr0"}]},{type:"view",align_children:"align_row",elements:[{type:"static_text",name:__("After:",'bkmNameReg'),width:50,alignment:"align_right",},{type:"edit_text",width:260,alignment:"align_fill",item_id:"sufx"},{type:"popup",width:17,item_id:"mcr1"}]}]},{type:"cluster",name:__("Transformations",'bkmNameReg'),elements:[{type:"view",align_children:"align_row",elements:[{type:"static_text",name:__("Case:",'bkmNameReg'),width:50,alignment:"align_right",},{type:"popup",width:150,item_id:"case"}]},{type:"view",align_children:"align_row",elements:[{type:"static_text",name:__("Find:",'bkmNameReg'),alignment:"align_right",width:50},{item_id:"ftxt",type:"edit_text",PopupEdit:true,alignment:"align_left",width:280}]},{type:"view",align_children:"align_row",elements:[{type:"static_text",name:__("Replace:",'bkmNameReg'),alignment:"align_right",width:50},{item_id:"rtxt",type:"edit_text",PopupEdit:true,alignment:"align_left",width:240},{type:"popup",width:17,item_id:"mcr2"}]},{type:"view",align_children:"align_row",elements:[{type:'gap',width:50},{type:"check_box",name:__("Regular Expression",'bkmNameReg'),item_id:"usRE"},{type:"check_box",name:__("Case Sensitive",'bkmNameReg'),item_id:"casS"}]}]}]}]},{type:'view',align_children:'align_right',elements:[{type:'view',alignment:'align_fill',align_children:'align_right',elements:[{type:"ok_cancel",ok_name:__("Go",'bkmNameReg'),}]}]}]}};function zoomToAnn(annot,setPage=false,zFactor=0,sourceDoc=null){if(!annot?.doc&&!sourceDoc)return;if(!sourceDoc)sourceDoc=annot.doc;sourceDoc.bringToFront();const pageRect=new xutil.GetPageRectangle(sourceDoc,annot.page);let annBox=pageRect.fromDUS(annot.rect);let coords=[(annBox[2]+annBox[0])/2,(annBox[3]+annBox[1])/2];if(setPage)sourceDoc.pageNum=annot.page;if(zFactor){let pr=sourceDoc.pageWindowRect;let zm=[(pr[2]-pr[0])/(annBox[2]-annBox[0]),(pr[3]-pr[1])/(annBox[3]-annBox[1])];zm=Math.min(...zm.map(z=>Math.abs(z)));sourceDoc.zoom=zm*zFactor*100;}
sourceDoc.scroll(...coords);}
function renameBkms(data,renameList){const cPageNum=new Object(doc.viewState);const nBookmarks=renameList[renameList.type].length;const rnmStatus=app.thermometer;rnmStatus.duration=nBookmarks;rnmStatus.begin();rnmStatus.text=('pages'===renameList.type)?__('Adding %1 Bookmarks…','bkmNameReg',nBookmarks):__('Renaming %1 Bookmarks…','bkmNameReg',nBookmarks);const mPXE=new xutil.PXEmacro(doc);nameBookmarks(data,renameList);doc.viewState=cPageNum;rnmStatus.end();return;function nameBookmarks(data,bkmList){const bkMacro=/%\[BookmarkName\]/gi;for(let b of bkmList[bkmList.type]){if(rnmStatus.cancelled)return;rnmStatus.value++;let oldName;let page;switch(bkmList.type){case'pages':oldName='';page=b;break;case'bookmarks':oldName=("Root"===b.name)?'':b.name;b.execute();page=doc.pageNum;doc.viewState=cPageNum;}
mPXE.page=page;const pageWords=new PageRectWords(doc,page);const pageRect=new xutil.GetPageRectangle(doc,page);let newName='';for(let d of data){let nStep=mPXE.apply(d.prex??'');if(d.rect){let rect=pageRect.fromRel(d.rect,d.align);let words=pageWords.words(rect,d.srtX,d.rmPW,d.wdsI);nStep+=words.join(' ');}
nStep+=mPXE.apply(d.sufx??'');let fSrc=d.ftxt;if(fSrc||fSrc===0){fSrc=d.usRE?fSrc:fSrc.replace(/([\.\(\)\\\|\[\]\{\}\+\-\*\$\^\,\?])/g,"\\$1");let caseSens=d.casS?"":"i";let fRE=new RegExp(fSrc,"g"+caseSens);let reTx=mPXE.apply(d.rtxt??'');nStep=nStep.replace(fRE,reTx);}
switch(d.case){case 1:nStep=nStep.toUpperCase();break;case 2:nStep=nStep.toLowerCase();break;case 3:nStep=nStep.replace(/\w[^-\s]*/g,txt=>txt.charAt(0).toUpperCase()+txt.substr(1).toLowerCase());break;case 4:nStep=nStep.replace(/\w[^-\s]*/g,(txt,i)=>{let tc=txt.toLowerCase();if(i&&TITLE_LOWER_CASE.includes(tc.trim())){return tc;}
return txt.charAt(0).toUpperCase()+tc.substr(1);});}
nStep=nStep.replace(bkMacro,oldName);newName+=nStep;}
switch(bkmList.type){case'pages':doc.pageNum=page;xutil.addBookmark(newName,doc);doc.viewState=cPageNum;break;case'bookmarks':b.name=newName;}
if(setLabel){const setNextPage=(page+1)<doc.numPages&&(page+2).toString()===doc.getPageLabel(page+1);try{doc.setPageLabels(page,['',newName]);}catch{doc.setPageLabels(page,['D',newName+' ',1]);}finally{if(setNextPage)doc.setPageLabels(page+1);}}}
return;}}
function getAllBookmarks(bkRoot){const bk=[];for(let b of bkRoot.children||[]){bk.push(b);if(b.children){bk.push(...getAllBookmarks(b));}}
return bk;}
function getPagesFromText(pgTxt,nPages){let pgD=pgTxt.replace(/(\d)\s+(\d)/g,'$1,$2').split(/[\s,]+/);const allPgN={};for(let p of pgD){if(/-/.test(p)){let pp=p.split(/[-\s]+/);let pStart=parseInt(pp[0]??0)||1;if(pStart<1)pStart=1;let pEnd=parseInt(pp[1]??0)||nPages;if(pEnd>nPages)pEnd=nPages;for(let i=pStart-1;i<pEnd;i++){allPgN[i]=true;}}else{let pp=parseInt(p);if(pp)allPgN[pp-1]=true;}}
return Object.keys(allPgN).map(v=>parseInt(v)).sort((a,b)=>a-b);}
class PageRectWords{doc;pg;constructor(doc,nPage){this.doc=doc;this.page=nPage??doc.pageNum;}
get page(){return this.pg;}
set page(pageNo){this.pg=pageNo;this.wordData=null;}
get rotation(){return this.constructor.getPgRotation(this.doc,this.page,true);}
static getPgRotation(doc,page,view=false,reverse=1){let pgRotation=doc.getPageRotation({nPage:page});if(view&&doc.viewState.pageViewRotation){pgRotation+=doc.viewState.pageViewRotation;}
pgRotation=(reverse*pgRotation)%360;if(pgRotation<0){pgRotation+=360;}
return pgRotation;}
words(rect,sortOrder,bStrip=0,allInside=true){const wordList=this.wordsInside(rect,bStrip,allInside);if(sortOrder&&wordList.length){this.sortWords(wordList,sortOrder);}
return wordList.map(w=>w[0]);}
cacheWords(page=this.page){const sQuote='"\u00ab\u2018\u201b\u201c\u201f';this.wordData=[];const pNWords=this.doc.getPageNumWords(page);for(let n=0;n<pNWords;n++){let word=this.doc.getPageNthWord(page,n,false);let quads=this.doc.getPageNthWordQuads(page,n);let prev=this.wordData[this.wordData.length-1];if(prev&&-1<sQuote.indexOf(prev[0].trim())){prev[0]=prev[0]+word;prev[1]=quads.concat(prev[1]);prev[2]=centroid(prev[1]);}else{let ctr=centroid(quads);this.wordData.push([word,quads,ctr]);}}
return this.wordData;function centroid(quads){let ctr=[];for(let qs of quads){let nq=qs.length/2;let qCtr=qs.reduce(function(acc,curr,i){acc[i%2]+=curr/nq;return acc;},[0,0]);ctr=qCtr.map((q,i)=>q+(ctr[i]??0));}
return ctr;}}
wordsInside(rect,bStrip,allInside){const strWS=/\s/g;const strPWS=/[.,\/\\"#!$%\^&\*;:{}=\-_`~()“”\s]/g;const words=[];const pgWords=this.wordData||this.cacheWords();for(let w of pgWords){let[word,quads,ctr]=w;switch(bStrip){case 1:word=word.replace(strWS,'');break;case 2:word=word.replace(strPWS,'');}
if(word.length&&this.inside(rect,allInside?quads:[ctr])){words.push([word,quads,ctr]);}}
return words;}
sortWords(wordArr,sortOrder){if(!sortOrder[0]&&!sortOrder[1])return wordArr;const decPlc=3;const dirMap=[[0,1,2,3,4],[0,3,4,2,1],[0,2,1,4,3],[0,4,3,1,2]];const rotOrder=sortOrder.map(s=>dirMap[this.rotation/90][s]);wordArr.sort(wordSort);return wordArr;function wordSort(a,b){let[ax,ay]=a[2];let[bx,by]=b[2];let sVal=0;for(let i=0;0===round(sVal,decPlc)&&i<2;i++){switch(rotOrder[i]){case 1:sVal=by-ay;break;case 2:sVal=ay-by;break;case 3:sVal=ax-bx;break;case 4:sVal=bx-ax;break;}}
return round(sVal,decPlc);}
function round(val,dPl=0){return Math.round(val*10**dPl)/10**dPl;}}
inside(rect,quads){const minMax=[min(rect[0],rect[2]),min(rect[1],rect[3])];function min(a,b){return a<b?[a,b]:[b,a];}
let inside=true;for(let qs of quads){qs.forEach((c,i)=>{inside=inside&&c>=minMax[i%2][0];inside=inside&&c<=minMax[i%2][1];});if(!inside)break;}
return inside;}}
const doSearchDialog=(function(doc,searchData,curProf){let edField;if("object"===typeof app.pxceVersion&&app.pxceVersion[3]<=386){const getObj=function(obj,prop,val){let found;if(obj[prop]===val){return obj;}else{if(obj.elements){for(let e in obj.elements){found=getObj(obj.elements[e],prop,val);if(found)break;}}}
return found;};const editBox={type:"button",name:__("Edit…",'bkmNameReg'),width:50,alignment:"align_left",item_id:"EdRg"};getObj(bkmRegionDialog.description,"item_id","ctrls").elements.splice(1,0,editBox);const txtNote={type:"static_text",name:__("When selecting a different step, press 'Edit' to update the fields on the right side.",'bkmNameReg'),alignment:"align_fill",width:250,};getObj(bkmRegionDialog.description,"item_id","Lcol").elements.push(txtNote);}
return function(ann){edField=edField??0;if(ann){const rec=new xutil.GetPageRectangle(doc,ann.page);let align=getAlign(searchData[curProf][edField]);searchData[curProf][edField]['rect']=rec.toRel(ann.rect,align);annSetProps(ann);}else if(searchData?.[curProf]?.[edField]){let relR=searchData[curProf][edField]['rect'];let align=getAlign(searchData[curProf][edField]);if(relR){const rec=new xutil.GetPageRectangle(doc,doc.pageNum);ann=doc.addAnnot({type:"Square",page:doc.pageNum,rect:rec.fromRel(relR,align)});annSetProps(ann);}}
bkmRegionDialog.curProf=curProf;bkmRegionDialog.profiles=searchData;bkmRegionDialog.ann=ann;bkmRegionDialog.selStage=edField;let result=app.execDialog(bkmRegionDialog);edField=bkmRegionDialog.selStage;switch(result){case'ok':annClear(ann);BK_PREFS.set({profile:curProf,data:searchData,findHist,replHist,setLabel});return renameBkms(searchData[curProf],bkmRegionDialog.selPages);case'pickarea':annClear(ann);xutil.getNewAnn(doSearchDialog,doc,"cmd.tool.annot.square",50);return'pick region';default:annClear(ann);doc.dirty=dDirtyState;return result;}
function annSetProps(ann){ann.setProps({fillColor:["RGB",0.5,1,0.5],strokeColor:["RGB",0.2,0.8,0.2],borderEffectStyle:'',width:2,author:"Rect Selection",opacity:0.7,print:false,subject:__("Area selection marker",'bkmNameReg'),});}
function getAlign(region){let alignArr=region["align"];if(!(alignArr&&alignArr.length))
alignArr=[0,2];return alignArr;}
function annClear(ann){if("object"===typeof ann){ann.destroy();}}};})(doc,searchData,curProf);doSearchDialog();};})();