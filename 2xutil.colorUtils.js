/** Utility to deal with color dialogs, saving and editing custom color lists,
  *   hex/dec conversion of color strings
  *
  * <pre>version history
  *  v2.1.2 2025-08-04 use colArr256() in colObj() if can't find color name
  *  v2.1.1 2025-07-07 fix bug when one of the custom colors deleted
  *  v2.1   2025-07-02 fix some duplicated color names; add hideLinks parameter to color picker; fix errors when making dialog if color is null; code cleanup in main loop; slight change to method of finding nearest color
  *  v2.0   2025-06-30 add color box picker option; add color boxes to editColrNames; add new method editCustomColors; lint cleanup; add .useHex property; document code; standard colors rearranged and based on @mCHSNUg5Pz8cPap forum post https://forum.pdf-xchange.com/viewtopic.php?t=46178
  *  v1.2   2025-03-30 make equal a static property so can use xutil.ClrUtx.equal()
  *  v1.1   2024-11-18 add noSave parameter to editColrNames()
  *  v1.0.1 2024-11-18 check if supplied color string undefined in colFromStr
  *  v1.0   2024-09-18 revised to separate xutil, added own persistent global, added translation, make color name based on nearby colors
  *  v0.1 part of change colors tool</pre>
  *
  * @author mathew
**/
"undefined"==typeof xutil&&Object.defineProperty(globalThis,"xutil",{value:{},writable:!1}),xutil.ClrUtx=class{static defaultColors={Transparent:"",White:"FF","86% Gray":"DA","Light Gray":"c0",Gray:"80","40% Gray":"66","25% Gray":"40",Black:"00",Lavender:"e6dcfd","Purple Sky":"d6c1ff","Pale Purple":"b392f0",Metal:"7B7BC0",Blurple:"6a5acd",Purple:"5a33a4",Indigo:"4B0082",Plum:"480048","Blue White":"dbedff","Sky Blue":"C0FFFF",Cyan:"FF000000",Blue:"0000FF","Blue Teal":"0055b8",Navy:"003e84","Dark Blue":"00008B","Midnight Blue":"00005E","Light Mint":"dcffe4","Pale Green":"98FB98","Bright Green":"00FF00",Lime:"32CD32","Sea Green":"3CB371",Teal:"388E8E",Green:"009300","Dark Green":"005500","Light Yellow":"FFFFE0","Rose Yellow":"fbf5cb",Yellow:"0000FF00",Turmeric:"fbdb59",Gold:"FFD700",Mustard:"e4b320",Brown:"A58E00",Ochre:"735c0f","Warm White":"ffebda",Peach:"ffd1ac","Light Orange":"FFAD5B",Tangerine:"fb8532",Orange:"FF6820",Cinnamon:"dc5d00","Dark Orange":"c24e00",Terracotta:"a04100",Rose:"FFE4E1","Pink Red":"fdaeb7","Pale Red":"f98080","Light Red":"ea4a5a",Red:"FF0000","Racing Red":"c21629","Deep Red":"a01e24","Dark Red":"8B0000",Thistle:"fedbf0",Pink:"FFC0CB",Candy:"ec6cb9",Magenta:"00FF0000","Hot Pink":"e848a8",Maroon:"99306f",Violet:"800080",Merlot:"6d224f","Dust White":"f8f1df","Brown Haze":"e9ddc4","Pale Tan":"d4c0ad",Tan:"D2B48C","Gray Brown":"b39f8d",Mud:"8b7566","Dark Brown":"5a493d","Deep Brown":"443428"};constructor(...t){this.equal=this.constructor.equal,this.to256=this.constructor.to256,this.otherColorText=__("Other - Enter:","xutil"),this.saveColors=t[0]?.saveColors??t[0]??!1;let e=t[0]?.aAnnots??t[1];this.useHex=t[0]?.useHex??t[2]??!0,this.boxDims=t[0]?.boxDims??t[3]??[46,23],this.hideLinks=t[0]?.hideLinks??t[4],this.mkName=t[0]?.mkName??t[5]??!0,this.defaultColors={};for(let t in this.constructor.defaultColors)this.defaultColors[__(t,"xutil")]=this.colFromHex(this.constructor.defaultColors[t]);let r={};if(this.saveColors){r=this.globals.get()??{colors:{"Light Blue":"FF7D9EC0",Aqua:"FF7FFFD4",Turquoise:"FF40E0D0"},hideLinks:this.hideLinks};const t=Object.keys(r);if(!r.colors&&t.length){xutil.ClrUtx.hexWithOpacity(Object.values(r));r={colors:this.arraysToOClrObs(this.clrObsToArrays(r))}}null==this.hideLinks&&(this.hideLinks=r.hideLinks??40)}this.setSavedColors(this.oClrObsToArrays(r.colors??{})),this.annotCls=this.getColors(e,[],!0,this.mkName)}setSavedColors(t){let e={},r={};if(Array.isArray(t)){const[s,i]=t;if(!Array.isArray(s)||!Array.isArray(i))return;s.forEach(((t,r)=>e[t]=i[r])),r=this.arraysToOClrObs(t)}else{if("object"!=typeof t)return;e=t,r=this.arraysToOClrObs(this.clrObsToArrays(t))}this.savedCls=e||{},this.saveColors&&this.globals.set({colors:r,hideLinks:this.hideLinks})}getSavedColors(t=!1,e=!0){if(this.saveColors){const t=this.globals.get();this.savedCls=t?.colors?this.arraysToClrObs(this.oClrObsToArrays(t.colors)):this.savedCls}let r={};e&&Object.assign(r,this.defaultColors),Object.assign(r,this.savedCls);let s=Object.values(Object.assign({},this.defaultColors,this.savedCls)),i=this.findColors(Object.values(this.annotCls),s);Object.assign(r,this.colObj(i));let o=this.clrObsToArrays(r);return t&&(o[0].unshift(this.otherColorText),o[1].unshift("")),o}getColors(t,e,r=!0,s=this.mkName){let i=[];for(let e in t){let r=t[e];r.richContents&&r.richContents.length&&(i=i.concat(r.richContents.map((t=>t.textColor)))),r.strokeColor&&i.push(r.strokeColor),r.fillColor&&i.push(r.fillColor)}return i=this.findColors(i,e),this.colObj(i,s,r)}findColors(t,e){let r=[];for(let s of t){e.some((t=>this.equal(s,t)))||r.push(s)}return r}addlClrs(t,e){void 0===e&&(e=Object.assign({},this.savedCls)),Array.isArray(t[0])||(t=[t]);let r=this.findColors(t,Object.values(this.defaultColors));return r.length&&(r=this.findColors(r,Object.values(e))),r.length&&Object.assign(e,this.colObj(r)),e}colObj(t,e,r=!1){void 0===e&&(e=this.mkName);let s={};for(let i of t){let t=this.colName(i,e,r);void 0===t&&(t=this.colArr256(i)),s[t]=i}return s}colName(t,e,r=!1){if(!t)return;void 0===e&&(e=this.mkName);let s=Object.keys(this.defaultColors),i=s.find((e=>this.equal(this.defaultColors[e],t)));return void 0===i&&r&&(s=Object.keys(this.savedCls),i=s.find((e=>this.equal(this.savedCls[e],t)))),void 0===i&&e&&(i=this.makeColorName(t)),i}makeColorName(t,e,r){if(!t)return;if("G"===t[0]){let e=Math.round(100*t[1]);return __("Gray","xutil")+` ${e}%`}(!e||e<2)&&(e=2);const s=[],i=Object.assign({},this.defaultColors,r);for(let e in i)s.push({name:e,diff:l(t,i[e])});s.sort(((t,e)=>t.diff-e.diff));let o=s[0].name.toString();if(s[0].diff)for(let t=1;t<e;t++)o+="-"+s[t].name;return o;function l(t,e){if("T"===t[0]||"T"===e[0])return t[0]===e[0]?0:1e11;let[r,s]=[t,e].map((t=>color.convert(t,"RGB").slice(1)));return r.reduce(((t,e,r)=>t+(255*e-255*s[r])**2),0)}}colArr256(t,e){return e??this.useHex?this.colStrHx(t):this.colStrDc(t)}colorToG(t){if(!t)return t;const e=this.to256;switch(t[0]=t[0].toUpperCase(),t[0]){case"RGB":e(t[1])===e(t[2])&&e(t[1])===e(t[3])&&(t=["G",t[1]]);break;case"CMYK":0===e(t[1])&&0===e(t[2])&&0===e(t[3])&&(t=["G",1-t[4]])}return t}colStrDc(t){let e=this.colorToG(t);return e=e.reduce(((t,e)=>t+", "+this.to256(e))),e}colStrHx(t){let e=this.colorToG(t);return e=e.slice(1).reduce(((t,e)=>t+util.printf("%x",this.to256(e)).padStart(2,"0")),""),e}colFromStr(t,e){return void 0===t&&(t="00"),void 0===e&&(e=""===t.trim()||/^[#0-9A-F]+$/i.test(t.trim())),e?this.colFromHex(t):this.colFromDec(t)}colFromDec(t){let[e,...r]=t.split(",");return r=r.map((t=>t/255)),this.colorToG([e].concat(r))}colFromHex(t){let e=t.replace(/[^0-9A-F]/gi,"");if(""===e)return["T"];let r,s=e.match(/.{1,2}/g);switch(s=s.map((t=>parseInt(t,16)/255)),s.length){case 3:r="RGB";break;case 4:r="CMYK";break;default:r="G"}return s=this.colorToG([r].concat(s)),s}static equal(t,e){if("G"===t[0]?t=color.convert(t,e[0]):e=color.convert(e,t[0]),t[0]!==e[0])return!1;let r=0;switch(t[0]){case"G":r=1;break;case"RGB":r=3;break;case"CMYK":r=4}for(let s=1;s<=r;s++)if(this.to256(t[s])!==this.to256(e[s]))return!1;return!0}static to256(t){return Math.round(255*t)}clrObsToArrays(t){return[Object.keys(t),Object.values(t)]}arraysToClrObs(t){let[e,r]=t;return e.reduce(((t,e,s)=>Object.assign(t,{[e]:r[s]})),{})}oClrObsToArrays(t){const e=Object.values(t),r=e.map((t=>{return e=t.substring(0,2),parseInt(e??"0",16)/255;var e})),s=e.map((t=>this.colFromHex(t.substring(2))));return[Object.keys(t),s,r]}arraysToOClrObs(t){let[e,r,s]=t;return s=(s??[]).map((t=>{return e=t||0,Math.floor(255*e).toString(16).padStart(2,"0");var e})),r=r.map(this.colStrHx,this),e.reduce(((t,e,i)=>Object.assign(t,{[e]:r[i]?(s[i]??"FF")+r[i]:"00"})),{})}editColrNames(t,e,r){return!this.editCustomColors(t,r,e).cancelled&&this.getSavedColors(!0,!0)}editCustomColors(...t){const e=this,r=this.constructor,s=t[0]?.addColors??t[0],i=t[0]?.noCheckbx??t[1]??[];let o=t[0]?.useHex??t[2]??this.useHex,l=t[0]?.width??t[3]??e.boxDims[0],a=t[0]?.height??t[4]??e.boxDims[1];const n=Array.isArray(s)?e.arraysToClrObs(s):s;let c=Object.assign({},e.savedCls,n);const[h,d]=e.clrObsToArrays(c);let u,f="add";for(;"add"===f;){const t={defaultColor:color.black,initialize(t){let s={};const n=h.length;for(let t=0;t<n;t++){let n=util.printf("%02d",t);s["sv"+n]=!i.includes(h[t]),s["cE"+n]=h[t],s["cI"+n]=r.colorBox(r.hexRGBfromClr(d[t],1),l,a),s["cL"+n]=e.colArr256(d[t],o)}s.Cfmt=o,t.load(s)},commit(t){const e=t.store();i.length=0,d.forEach(((t,r)=>{let s=util.printf("%02d",r);h[r]=e["cE"+s],e["sv"+s]||i.push(h[r])}))},addG(t){this.commit(t),d.push(this.defaultColor),h.push(e.colName(this.defaultColor,!0,!1)),t.end("add")},updateColor(t,s){const i=t.store(),o=e.colFromStr(i["cL"+s]),n=parseInt(s);e.equal(o,d[n])||(d[n]=o,t.load({["cI"+s]:r.colorBox(r.hexRGBfromClr(o,1),l,a)}))},Cfmt(t){const r=t.store();if(o!==r.Cfmt){o=r.Cfmt;const s={};d.forEach(((t,r)=>{s[util.printf("cL%02d",r)]=e.colArr256(t,o)})),t.load(s)}},HpCl(t){e.colorFormatHelp(o)},description:{name:__("Edit Color Names","xutil"),elements:[{type:"cluster",name:__("Colors","xutil"),align_children:"align_left",elements:[{type:"view",align_children:"align_row",elements:[{type:"static_text",name:__("Save","xutil"),bold:!0,width:30},{type:"static_text",name:__("Color Name","xutil"),bold:!0,width:160},{type:"static_text",name:__("Color","xutil"),bold:!0,width:120+l}]},{type:"view",align_children:"align_left",item_id:"Ctnr",elements:[]},{type:"button",item_id:"addG",name:"+",font:"title",bold:!0,width:22,height:22}]},{type:"view",align_children:"align_fill",width:310,elements:[{type:"check_box",name:__("Hexadecimal","xutil"),item_id:"Cfmt",width:280},{type:"ok_cancel",alignment:"align_right"}]}]}};let s=this.getObj(t.description,"item_id","Ctnr");s.name=__("%1 Custom Colors:","xutil",h.length);for(let r in h){let i=util.printf("%02d",r),n={type:"view",align_children:"align_row",elements:[{type:"check_box",width:30,item_id:"sv"+i},{type:"edit_text",width:160,item_id:"cE"+i},{type:"image",width:l,height:a,item_id:"cI"+i},{type:"edit_text",width:120,alignment:"align_left",bold:!0,item_id:"cL"+i,name:e.colArr256(d[r],o)},{type:"button",name:"?",item_id:"HpCl",height:16,width:12}]};s.elements.push(n),t["cL"+i]=function(t){this.updateColor(t,i)}}f=app.execDialog(t)}if("ok"!==f)return Object.assign(new xutil.ClrUtx(e.saveColors),e,{cancelled:!0});u=[],d.forEach(((t,e)=>{i.includes(h[e])||u.push([h[e],t])}));const m={};for(const[t,e]of u)m[t]=e;return e.setSavedColors(m),e}getObj(t,e,r){let s;if(t[e]===r)return t;if(t.elements)for(let i in t.elements)if(s=this.getObj(t.elements[i],e,r),s)break;return s}colorFormatHelp(t=this.useHex){const e=[__("The first element in the comma separated list is a string denoting the color space. The subsequent elements are numbers that range between zero and 255 inclusive. \nFor example, the color red can be represented as [RGB, 255, 0, 0].\nColor Space options are:\n   T (Transparent),\n   G (Gray - single value [G,0] is black),\n   RGB (3 values),\n   CMYK (4 values).","xutil"),__("This is a series of hexadecimal pairs.\nOptions are:\n   Empty '' (Transparent),\n   2 digits Gray (ie '00' is black),\n   6 digits RGB (RRGGBB),\n   8 digits CMYK (CCMMYYKK)","xutil")];app.alert({cTitle:__("Color Format Help","xutil"),cMsg:e[t?1:0],nIcon:2,nType:0})}colorPicker(...t){const e=this.constructor,r=this;let s="number"==typeof t[0]?t[0]:t[0]?.columns??8,i=t[0]?.width??t[1],o=t[0]?.height??t[2];i&&o||([i,o]=r.boxDims);const l=t[0]?.useHexadecimal??t[3]??r.asHex,a=t[0]?.showNames??t[4];let n=t[0]?.basicColors??t[5],c=t[0]?.customColors??t[6];const h=t[0]?.selectedColor??t[7];n||(n=r.clrObsToArrays(r.defaultColors),!c&&r.saveColors&&(c=r.getSavedColors(!1,!1)));let[d,u,f]=Array.isArray(n[1]?.[0])?n:[[],n,[]];const[m,g,p]=Array.isArray(c?.[1]?.[0])?c:[[],c,[]],C=t[0]?.showEditButton??t[8]??!!g,b=t[0]?.arrangeVertically??t[9]??!0,y=t[0]?.colorPickerText??t[10]??__("Select a color:","xutil");r.hideLinks=t[0]?.hideLinks??t[11]??r.hideLinks;const[x]=h?e.hexWithOpacity([h]):[];function _(t,e){return t.toString(36).padStart(e,"0")}if(b&&u.length>s){const t=t=>Object.keys(t[0]).map((e=>t.map((t=>t[e])))),e=(t,e)=>{const r=[],s=Math.ceil(t.length/e);for(let i=0;i<s;i++)r[i]=t.slice(i*e,i*e+e);return r};d&&(d=t(e(d,s)).flat(1)),u=t(e(u,s)).flat(1),f&&(d=t(e(f,s)).flat(1)),s=Math.ceil(u.length/s)}const v=(t,e,r,s,i,o)=>{const l=Math.max(r,40),a={type:"view",align_children:"align_top",elements:[]};return t.forEach(((t,n)=>{let c=x===i[n],h=_(n+e,2);a.elements.push(i[n]?((t,e,r,s,i)=>{let a={type:"image",item_id:`cl${e}`,width:r,height:s};return o||(a={type:"view",align_children:"align_center",elements:[a,{type:"link_text",name:t,item_id:`cb${e}`,font:"palette",width:l,height:14,bold:i}]}),a})(t,h,r,s,c):{type:"gap",width:Math.max(r,o?0:l),height:s})})),a},k=(t,e,r,s=0,l=0)=>{const a=Math.ceil(t.length/e),n=l&&l<=t.length,c={type:"view",align_children:"align_left",elements:[]};for(let l=0;l<a;l++){const a=l*e,h=t.slice(a,a+e),d=h.map(((t,e)=>{if(r?.[e+a])return r[e+a];if(t){let e=t.substring(2).toUpperCase(),r=parseInt(t.substring(0,2),16);return 0===r?e="Transparent":255!==r&&(e+="\n@ "+Math.round(r/255*100)+"%"),e}}));c.elements.push(v(d,s+a,i,o,h,n))}return c},O={colors:[],showEdit:C,customColorsLength:0,initialize(t){const s={};this.colors.forEach(((t,r)=>{s["cl"+_(r,2)]=e.colorBox({hexColor:t,width:i,height:o,outline:t===x})})),s.cmpt=r.hideLinks&&r.hideLinks<=u.length,t.load(s),this.showEdit||t.visible({edCN:!1})},cncl(t){t.end("cancel")},edCN(t){let s=r.findColors(g,Object.values(r.savedCls));s=s.map((t=>m[g.findIndex((e=>r.equal(t,e)))]));const n=r.editCustomColors([m,g],s,l);if(n.cancelled)return;const[c,h]=n.getSavedColors(!1,!1),d={},f={};let p=this.customColorsLength<h.length;const C=u.length,b=e.hexWithOpacity(h);for(let t=0;t<Math.max(this.customColorsLength,h.length);t++){const s=_(t+C,2);h[t]?g[t]&&c[t]===m[t]&&r.equal(h[t],g[t])||(g[t]=h[t],m[t]=c[t],p||(d[`cl${s}`]=e.colorBox(b[t],i,o),d[`cb${s}`]=a??c[t]?c[t]:r.colArr256(h[t],l),f[`cl${s}`]=!0,f[`cb${s}`]=!0)):(f[`cl${s}`]=!1,f[`cb${s}`]=!1,g.pop(),m.pop())}(p||Object.keys(d).length||Object.keys(f).length)&&r.setSavedColors([c,h]),p?t.end("redraw"):(Object.keys(d).length&&t.load(d),Object.keys(f).length&&t.visible(f))},cmpt(t){r.hideLinks=t.store().cmpt?u.length:0,t.end("redraw")},description:{name:__("Colors","xutil"),elements:[{type:"view",item_id:"CPks",elements:[]},{type:"view",align_children:"align_row",elements:[{type:"button",item_id:"edCN",alignment:"align_left",width:170,name:__("Edit custom colorsâ€¦","xutil")},{type:"check_box",item_id:"cmpt",width:70,name:__("Compact View","xutil")},{type:"spacer",width:Math.max(0,-100,Math.min(u.length,s)*(6+i)-170-70-60-8)},{type:"button",item_id:"cncl",alignment:"align_right",width:60,name:__("Cancel","xutil"),bold:!0}]}]},addHandler(t,e=0){let r=_(t+e,2);this[`cl${r}`]=this[`cb${r}`]=function(r){const s=e?g[t]:u[t],i=e?p?.[t]:f?.[t];this.results=null!=i?{value:s,opacity:i}:s,r.end("ok")}}},F=this.getObj(O.description,"item_id","CPks").elements;let w="redraw";for(;"redraw"===w;){if(F.length=0,g){const t=e.hexWithOpacity(g,p);O.colors.unshift(...t);const i=u.length,o=a??m.length?m:g.map(((t,e)=>r.colArr256(t,l)));F.unshift(k(t,s,o,i)),F.unshift({type:"static_text",name:"Custom Colors",separator:1,alignment:"align_left"}),g.forEach(((t,e)=>O.addHandler(e,i))),O.customColorsLength=g.length}const t=e.hexWithOpacity(u,f);O.colors.unshift(...t);const o=a??d.length?d:u.map(((t,e)=>r.colArr256(t,l)));if(F.unshift(k(t,s,o,0,this.hideLinks)),u.forEach(((t,e)=>O.addHandler(e))),F.unshift({type:"static_text",name:y,width:Math.max(200,Math.min(u.length,s)*i),bold:!0}),w=app.execDialog(O),"ok"===w)return r.saveColors&&r.globals.set(Object.assign(r.globals.get(),{hideLinks:r.hideLinks})),O.results}}static hexRGBfromClr(t,e){if(!t)return t;const r=t=>Math.floor(255*t).toString(16).padStart(2,"0");let s=void 0===e?"":r(e);return s+=color.convert(t,"RGB").slice(1).reduce(((t,e)=>t+r(e)),""),s}static hexWithOpacity(t,e){return t.map(((t,r)=>(t=>"T"===(t??"").toString().toUpperCase())(t)?"00000000":xutil.ClrUtx.hexRGBfromClr(t,e?.[r]??1)))}static colorBox(...t){const e="FF222222",r="DDDDDDDD",s="FF888888",i="string"==typeof t[0]?t[0]:t[0]?.hexColor;if(!i)return;let o=t[0].width??t[1],l=t[0].height??t[2];"number"!=typeof o&&(o=21),"number"!=typeof l&&(l=o-1);const a=t[0].outline??t[3];let n=t[0].strw??t[4];"number"!=typeof n&&(n=Math.round(o/20));let c;if("ff"===i.substring(0,2).toLowerCase())c=i.repeat(o*l);else{c="";let t=0;const e=(o-n)/(l-1);let r=o-n;for(let s=0;s<l;s++){t+=e-Math.round(t);let s=i.repeat(r);s+="FFFF0000".repeat(n),s+=i.repeat(o-r-n),r-=Math.round(t),c+=s}}if(a){let t=new RegExp(".{1,"+8*o+"}","g"),i=c.match(t);i.forEach(((t,l)=>{switch(l){case 0:case i.length-1:i[l]=r+e.repeat(o-2)+r;break;case 1:case i.length-2:i[l]=e+s+r.repeat(o-4)+s+e;break;default:i[l]=e+r+t.substring(16,t.length-16)+r+e}})),c=i.join("")}return{read:function(t){return c.slice(this.count,this.count+=2*t)},width:o,height:l,count:0}}},xutil.ClrUtx.prototype.globals=(t=>({get:app.trustedFunction((()=>{if(app.beginPriv(),global[t])return JSON.parse(global[t])})),set:app.trustedFunction((e=>{app.beginPriv(),global[t]=JSON.stringify(e),global.setPersistent(t,!0)}))}))("ClrUtx_savedValues");